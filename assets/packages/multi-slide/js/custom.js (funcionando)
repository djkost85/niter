/* Custom modules used:
 * Responsive
 * Preloader
 * Keyboard Controls (but manually removed)
 */

/* Here is the slider using default settings */
$('#slider-featured').liquidSlider({
  dynamicArrows:false,
  continuous:false,
  dynamicTabs:false,
  responsive: true
});

/* Config */
var sliderMaxWidth  = '300',
    maxNumberOfSlidesShown = 6,
    useAutoslide     = false,
    autoslideDelay  = 5000;
/* End Config */


// 600px using my defaults
var midSwitch = sliderMaxWidth * ((maxNumberOfSlidesShown - 1) / maxNumberOfSlidesShown),
// 300px using my defaults
    smallSwitch = sliderMaxWidth * ((maxNumberOfSlidesShown - 2) / maxNumberOfSlidesShown);
// Set more if you desire, but add conditionals below.

// conditionals based on the screen width, we show a different # of slides.
// You can also set different heights here as well
function determineSlidesShown() {
  if (sliderObject.slideWidth < smallSwitch) {
    // Switch to the smallest setting
    numberOfSlidesShown = maxNumberOfSlidesShown - 2;
  } else if (sliderObject.slideWidth < midSwitch) {
    // if that fails, move to the mid width
    numberOfSlidesShown = maxNumberOfSlidesShown - 1;
  } else {
    //This is for the heighest width
    numberOfSlidesShown = maxNumberOfSlidesShown;
  }
  setSlidesShown();
};

var weAreOnSlideNumber;
function setSlidesShown() {
  $('.liquid-slider-wrapper').css('max-width', sliderMaxWidth);
  $('.liquid-slider-wrapper .liquid-slider .panel').css('width', 100 / (sliderObject.panelCount * numberOfSlidesShown) + '%');

  // Store the first panel so we know where we are (also reset on resize)
  weAreOnSlideNumber = sliderObject.options.firstPanelToLoad - 1; // Make it 0 based
  //adjust current slide
  sliderObject.currentTab = (weAreOnSlideNumber);
  sliderObject.transition();
}

// Store the slider in an object. you shouldnt need to edit this
var sliderObject = $.data( $('#slider-featured')[0], 'liquidSlider');

// Store the first panel so we know where we are
var weAreOnSlideNumber = sliderObject.options.firstPanelToLoad - 1; // Make it 0 based

// Call above functions to determine and set the panels in view first load
determineSlidesShown();

// if the browser width changes...
var resizingTimeout;
// A timeout so it runs only after resizing is released
$(window).bind('resize', function () {
  clearTimeout(resizingTimeout);
    resizingTimeout = setTimeout(function () {
      // Send to adjust the height after resizing completes
      determineSlidesShown();
      sliderObject.transition();
    }, 500);
});

// The autoslide
var direction = '.arrow-right', // 1 => Slide right
    lsAutoslide;
function autoslideFn() {
  lsAutoslide = setTimeout(function() {
    // Direction is set based on slide position
    $(direction).trigger('click');
    autoslideFn();
  }, autoslideDelay);
}
// Call the autoslide if enabled
if (useAutoslide) {
  // You may want to run this on load if you have a lot of images
  //$(window).bind("load", function () {
    autoslideFn();
  //}
}

var maxFeatured = -1;

$(document).on('click', '#featuredLinks', function (e) {
  e.preventDefault();
  clearTimeout(lsAutoslide);
  var myurl = $(this).find('ul li:first-child a').attr('href');
  if (myurl)
  {
    if (weAreOnSlideNumber === 0) {
      direction = '.arrow-right';
      return false;
    }
    $.ajax(
    {
      url: myurl,
      type: "get",
      datatype: "html",
      beforeSend: function()
      {
        // Show Loading message
        // $('#ajax-loading').show();
      }
    })
    .done(function(data)
    {
      // Delete Loading message
      // $('#ajax-loading').hide();
      // Add new movies to the div
      if (data.count>0)
      {
        // Update the pagination and links
        // Slide movies
        $('#featuredLinks').empty().append(data.featuredLinks).find('ul li a').text("").ready(function(){
          sliderObject = $.data( $('#slider-featured')[0], 'liquidSlider');
          weAreOnSlideNumber -= numberOfSlidesShown;
          sliderObject.currentTab = sliderObject.currentTab - 1;
          sliderObject.transition();
        });
      }
    })
    .fail(function(jqXHR, ajaxOptions, thrownError)
    {
      alert('No response from server');
      direction = '.arrow-left';
      return false;
    });
  }
  else
  {
    myurl = $(this).find('ul li:last-child a').attr('href');
    if (myurl)
    {
      // First, check if we have loaded enough movies to the right
      if (weAreOnSlideNumber >= (sliderObject.panelCount - numberOfSlidesShown))
      {
        // I there are no more movies, we go to the database to get n more movies. We add them to the html structure and update the control
        $.ajax(
        {
          url: myurl,
          type: "get",
          datatype: "html",
          beforeSend: function()
          {
            // Show Loading message
            // $('#ajax-loading').show();
          }
        })
        .done(function(data)
        {
          // Delete Loading message
          // $('#ajax-loading').hide();
          // Add new movies to the div
          if (data.count>0)
          {
            // We found more movies, so we add them to the structure and then, more the slides
            // Adding movies to the structure
            $('#featuredLinks').empty().append(data.featuredLinks).find('ul li a').text("").ready(function(){
              if ((weAreOnSlideNumber > maxFeatured))
              {
                $('#slider-featured .panel-container').append(data.featured).ready(function(){
                  sliderObject = $.data( $('#slider-featured')[0], 'liquidSlider');
                  maxFeatured = weAreOnSlideNumber;
                });
              }
              weAreOnSlideNumber += numberOfSlidesShown;
              sliderObject.currentTab = sliderObject.currentTab + 1;
              sliderObject.transition();
            });
          }
          else
          {
          // If we can't find any movies, we do nothing
            direction = '.arrow-left';
            return false; 
          }
        })
        .fail(function(jqXHR, ajaxOptions, thrownError)
        {
          alert('No response from server');
          direction = '.arrow-left';
          return false;
        });

      }
      else
      {
        weAreOnSlideNumber += numberOfSlidesShown;
        sliderObject.currentTab = sliderObject.currentTab + 1;
        sliderObject.transition();
      }
    }
  }
});

$(document).ready(function(){
  $(this).find('#insideTablinks ul li a').text("");
})